<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地图标绘系统</title>
    <link rel="stylesheet" href="./css/antd.css">
    <link rel="stylesheet" href="./css/custom.css">
    <link rel="stylesheet" href="./css/map-styles.css">
    <!-- 百度地图API - 动态加载 -->
    <script>
        // 百度地图API加载状态
        window.baiduMapLoaded = false;
        window.baiduMapCallbacks = [];
        
        // 注册百度地图加载完成回调
        window.onBaiduMapLoaded = function(callback) {
            if (window.baiduMapLoaded && window.BMap && window.BMap.Map) {
                callback();
            } else {
                window.baiduMapCallbacks.push(callback);
            }
        };
        
        // 百度地图加载完成回调
        window.initBaiduMap = function() {
            window.baiduMapLoaded = true;
            console.log('百度地图API加载成功');
            window.baiduMapCallbacks.forEach(cb => cb());
            window.baiduMapCallbacks = [];
        };
        
        // 动态加载百度地图API
        (function() {
            fetch('/api/map-key')
                .then(res => res.json())
                .then(data => {
                    if (data.success && data.apiKey) {
                        // 百度地图JavaScript API 3.0 异步加载
                        window.BMap_loadScriptTime = (new Date).getTime();
                        const script = document.createElement('script');
                        script.type = 'text/javascript';
                        script.src = `https://api.map.baidu.com/getscript?type=webgl&v=1.0&ak=${data.apiKey}&services=&t=${Date.now()}`;
                        
                        script.onload = function() {
                            // 检测BMapGL是否加载成功
                            let checkCount = 0;
                            const checkBMap = setInterval(() => {
                                checkCount++;
                                if (window.BMapGL && window.BMapGL.Map) {
                                    clearInterval(checkBMap);
                                    // 创建BMap别名以兼容旧代码
                                    window.BMap = window.BMapGL;
                                    window.initBaiduMap();
                                } else if (checkCount > 50) {
                                    clearInterval(checkBMap);
                                    console.error('百度地图API加载超时');
                                }
                            }, 100);
                        };
                        
                        script.onerror = function() {
                            console.error('百度地图API脚本加载失败');
                        };
                        
                        document.head.appendChild(script);
                    } else {
                        console.error('无法获取百度地图API密钥');
                    }
                })
                .catch(err => {
                    console.error('获取百度地图API密钥失败:', err);
                });
        })();
    </script>
    <!-- Ant Design -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/antd/4.24.14/antd.min.js"></script>
</head>
<body>
    <div class="ma-app">
        <header class="ma-header">
            <span class="ma-title">地图标绘系统</span>
        </header>
        <main class="ma-main">
            <section class="ma-map-area"><div id="map-container"></div></section>
            <section class="address-drawer" id="drawerList">
                <button class="drawer-toggle-btn" id="drawerToggleBtn" title="隐藏/显示地址列表">
                    <svg viewBox="0 0 1024 1024" width="16" height="16" fill="currentColor">
                        <path d="M765.7 486.8L314.9 134.7A7.97 7.97 0 00302 141v77.3c0 4.9 2.3 9.6 6.1 12.6l360 281.1-360 281.1c-3.8 3-6.1 7.7-6.1 12.6V883c0 6.7 7.7 10.4 12.9 6.3l450.8-352.1a31.96 31.96 0 000-50.4z"></path>
                    </svg>
                </button>
                <button class="ma-upload-btn" id="upload-btn">
                    <svg width="20" height="20" fill="currentColor" style="vertical-align:middle;margin-right:6px;"><use xlink:href="#icon-upload"></use></svg>
                    上传Excel文件
                </button>
                <input type="file" id="excel-file" name="file" accept=".xlsx,.xls" style="display:none;">
                <div class="ma-list-title">地址列表</div>
                <ul class="ma-address-list" id="address-list">
                    <!-- 地址卡片由JS渲染 -->
                </ul>
                <div class="ma-pagination">
                    <button class="ma-page-btn" id="prev-page">&lt;</button>
                    <span class="ma-page-info"><span id="current-page">1</span> / <span id="total-pages">1</span></span>
                    <button class="ma-page-btn" id="next-page">&gt;</button>
                </div>
                <div id="upload-status" class="ma-upload-status"></div>
            </section>
        </main>
        <!-- 移动端地图/列表切换按钮 -->
        <button class="ma-fab" id="toggleViewBtn" style="display:none;">
            <svg width="24" height="24" fill="currentColor"><use xlink:href="#icon-list"></use></svg>
        </button>
        <!-- SVG 图标定义 -->
        <svg style="display:none;">
            <symbol id="icon-upload" viewBox="0 0 1024 1024"><path d="M512 128l256 256h-160v256h-192V384H256z"/><path d="M128 832h768v64H128z"/></symbol>
            <symbol id="icon-list" viewBox="0 0 1024 1024"><path d="M128 192h768v64H128zM128 480h768v64H128zM128 768h768v64H128z"/></symbol>
        </svg>
    </div>
    
    <script src="./js/main.js"></script>
</body>
</html>